server {
    server_name file.joshzhong.top;
    listen 443 ssl;
    ssl_certificate /usr/local/nginx/cert/file.joshzhong.top/file.joshzhong.top.pem;
    ssl_certificate_key /usr/local/nginx/cert/file.joshzhong.top/file.joshzhong.top.key;
    ssl_protocols TLSv1.2 TLSv1.3;

    root /data/software;
    charset utf-8,gbk;
    charset_types text/plain text/css application/javascript;

    # ä¸»ç›®å½•åˆ—è¡¨é…ç½®
    location / {
        autoindex on;
        autoindex_exact_size off;
        autoindex_localtime on;
        add_header Cache-Control "no-store, no-cache, must-revalidate";
        
        # æ³¨å…¥è‡ªå®šä¹‰æ ·å¼å’Œè„šæœ¬
        sub_filter '</head>' '<link rel="stylesheet" href="/nginx-custom.css"><script src="/fix-alignment.js"></script></head>';
        sub_filter '<h1>Index of ' '<h1>ğŸ“‚ ';
        sub_filter '<hr>' '';
        sub_filter '</body>' '<div class="footer">æ–‡ä»¶æœåŠ¡ | Powered by Nginx</div></body>';
        sub_filter_once off;
    }

    # æä¾›è‡ªå®šä¹‰CSS
    location = /nginx-custom.css {
        alias /usr/local/nginx/html/nginx-custom.css;
        expires 30d;
        add_header Cache-Control "public";
    }

    # æä¾›ä¿®å¤å¯¹é½çš„JS
    location = /fix-alignment.js {
        alias /usr/local/nginx/html/fix-alignment.js;
        expires 30d;
        add_header Cache-Control "public";
    }

    # é…ç½®æ˜¾ç¤º .pdf æ–‡ä»¶
    location ~* \.pdf$ {
        root /data/software;
        add_header Content-Type application/pdf;
        try_files $uri =404;
    }

    # é…ç½®æ˜¾ç¤ºè„šæœ¬å†…å®¹
    location ~* \.(sh|py|bat|md)$ {
        root /data/software;
        default_type text/plain;
        add_header Content-Type text/plain;
        try_files $uri =404;
    }

    # é…ç½®æ˜¾ç¤ºå›¾ç‰‡æ–‡ä»¶
    location ~* \.(jpg|jpeg|png|gif|bmp|svg|webp)$ {
        root /data/software;
        add_header Content-Type $content_type;
        try_files $uri =404;
    }

    # è‡ªåŠ¨æ’­æ”¾ mp3 æ–‡ä»¶
    location ~* \.mp3$ {
        root /data/software;
        add_header Content-Type audio/mpeg;
        try_files $uri =404;
    }

    # é˜»æ­¢ç›´æ¥è®¿é—®æ•æ„Ÿç›®å½•
    location ~ ^/(software|flask|venv) {
        return 404;
    }

    # é”™è¯¯é¡µé¢
    error_page 403 /403.html;
    location = /403.html {
        internal;
        return 403 "Access Forbidden";
    }

    error_page 404 /404.html;
    location = /404.html {
        internal;
        return 404 "Not Found";
    }
}
